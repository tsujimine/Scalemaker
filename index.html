<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonata Composer Studio [Analysis Mode]</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 0; line-height: 1.6; }
        header { background: #1a1a1a; color: white; padding: 1rem; text-align: center; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; }
        main { max-width: 1450px; margin: 1.5rem auto; padding: 0 1rem; }
        .section-box { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { font-size: 1.1rem; border-left: 4px solid #e63946; padding-left: 10px; margin-bottom: 15px; }
        
        /* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† */
        .project-manager { display: flex; gap: 10px; align-items: center; background: #333; color: white; padding: 10px 20px; border-radius: 8px; margin-bottom: 1rem; flex-wrap: wrap; }
        .project-btn { background: #555; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: none; font-size: 0.8rem; }
        
        /* æ§‹æˆãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ */
        .timeline-header { display: grid; grid-template-columns: 80px 80px 150px 180px 1fr 80px 40px; gap: 10px; padding: 10px; font-weight: bold; font-size: 0.8rem; border-bottom: 2px solid #eee; }
        .timeline-item { display: grid; grid-template-columns: 80px 80px 150px 180px 1fr 80px 40px; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 5px; }
        .timeline-item input, .timeline-item select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem; width: 100%; }
        .total-info { background: #e63946; color: #fff; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1.1rem; display: inline-block; margin-top: 10px; }
        
        /* éŸ³åã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ */
        .converter-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .converter-input label { display: block; font-size: 0.7rem; color: #666; text-align: center; margin-bottom: 5px; }
        .converter-input select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; font-size: 1rem; cursor: pointer; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; font-size: 0.85rem; }
        th { background: #333; color: white; padding: 10px; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .notes-text { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1rem; }
        
        /* è‰²ãƒ»ãƒãƒ¼ã‚¯ã®æŒ‡å®š */
        .in-scale { color: #2a9d8f; } 
        .out-scale { color: #f4a261; font-weight: normal; opacity: 0.7; } 
        .group-mark { display: inline-block; width: 22px; height: 22px; line-height: 22px; text-align: center; border-radius: 50%; background: #eee; color: #333; font-weight: bold; font-size: 0.75rem; margin-right: 8px; vertical-align: middle; border: 1px solid #ccc; }
        .chord-notes { color: #e63946; } 
        .add-btn { background: #2a9d8f; color: white; padding: 8px 15px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; margin-top:10px; }
        .del-btn { background: #ccc; color: white; border:none; border-radius:4px; cursor:pointer; height: 30px; }
    </style>
</head>
<body>

<header><h1>ğŸ¼ Sonata Composer Studio</h1></header>

<main>
    <div class="project-manager">
        <label>ğŸ“ æ›²ã‚’é¸æŠ:</label>
        <select id="projectList" onchange="switchProject()"></select>
        <button class="project-btn" onclick="createNewProject()">ï¼‹ æ–°è¦ä½œæˆ</button>
        <button class="project-btn" onclick="renameProject()">âœï¸ åå‰å¤‰æ›´</button>
        <div id="saveStatus" style="margin-left:auto; font-size:0.8rem; color:#2a9d8f;">è‡ªå‹•ä¿å­˜ä¸­</div>
    </div>

    <div class="section-box">
        <h2>æ¥½æ›²æ§‹æˆ & æ¼”å¥æ™‚é–“è¨­è¨ˆ</h2>
        <div id="timeline"></div>
        <button class="add-btn" onclick="addTimelineRow(); saveToLocal();">ï¼‹ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </button>
        <br>
        <div id="totalDisplay" class="total-info">ç·æ¼”å¥æ™‚é–“: 0åˆ† 0ç§’</div>
    </div>

    <div class="section-box">
        <h2>ãƒ¡ãƒ­ãƒ‡ã‚£å¤‰æ› & å…±é€šæ—‹æ³•åˆ†æ</h2>
        <p style="font-size: 0.75rem; color: #666; margin-bottom: 10px;">â€»å¤‰æ›å¾Œã®éŸ³ãŒå…¨ãåŒã˜ã‚‚ã®ã«ã¯â’¶â’·...ã®å…±é€šãƒãƒ¼ã‚¯ãŒã¤ãã¾ã™ã€‚</p>
        <div class="converter-grid" id="inputGrid"></div>
    </div>

    <div class="section-box">
        <h2>æ—‹æ³•ãƒãƒˆãƒªãƒƒã‚¯ã‚¹</h2>
        <div style="margin-bottom:15px;">
            <label>Root Key: <select id="keySelect" onchange="update()"></select></label>
        </div>
        <table>
            <thead>
                <tr>
                    <th style="width:180px;">ã‚¹ã‚±ãƒ¼ãƒ«å</th>
                    <th style="width:350px;">å¤‰æ›å¾Œã®ãƒ¡ãƒ­ãƒ‡ã‚£</th>
                    <th>éŸ³éšé †</th>
                    <th>3åº¦é †</th>
                    <th style="width:120px;">ã‚¤ãƒ¡ãƒ¼ã‚¸</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</main>

<script>
    const notesSharp = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const notesFlat  = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
    const majorScaleNotes = ["C", "D", "E", "F", "G", "A", "B", "C(oct)"];
    function n(name) { const idx = notesFlat.indexOf(name); return idx !== -1 ? idx : notesSharp.indexOf(name); }

    const scales = [
        { id: "ryukyu", name: "ç‰çƒéŸ³éš", intervals: [0, null, 4, 5, 7, null, 11], img: "å¤ªé™½", pref: "sharp" },
        { id: "ritsu", name: "å¾‹æ—‹æ³•", intervals: [0, 2, null, 5, 7, 9, null], img: "é›…æ¥½", pref: "sharp" },
        { id: "in", name: "é™°æ—‹æ³•", intervals: [0, 1, null, 5, 7, 8, null], img: "å“€æ„", pref: "flat" },
        { id: "china", name: "ä¸­å›½éŸ³éš", intervals: [0, 2, 4, null, 7, 9, null], img: "æ‚ ä¹…", pref: "sharp" },
        { id: "whole", name: "å…¨éŸ³éŸ³éš", intervals: [0, 2, 4, 6, 8, 10, null], img: "å¤¢å¹»", pref: "sharp" },
        { id: "mystic", name: "ç¥ç§˜éŸ³éš", intervals: [0, 2, 4, 6, 9, 10, null], img: "æ³•æ‚¦", pref: "sharp" },
        { id: "ionian", name: "ã‚¢ã‚¤ã‚ªãƒ‹ã‚¢ãƒ³", intervals: [0, 2, 4, 5, 7, 9, 11], img: "é•·éŸ³éš", pref: "sharp" },
        { id: "lydian", name: "ãƒªãƒ‡ã‚£ã‚¢ãƒ³", intervals: [0, 2, 4, 6, 7, 9, 11], img: "æµ®éŠæ„Ÿ", pref: "sharp" },
        { id: "mixo", name: "ãƒŸã‚¯ã‚½ãƒªãƒ‡ã‚£ã‚¢ãƒ³", intervals: [0, 2, 4, 5, 7, 9, 10], img: "ç¥ç¥­", pref: "flat" },
        { id: "dorian", name: "ãƒ‰ãƒªã‚¢ãƒ³", intervals: [0, 2, 3, 5, 7, 9, 10], img: "æ°—é«˜ã„", pref: "flat" },
        { id: "phrygian", name: "ãƒ•ãƒªã‚¸ã‚¢ãƒ³", intervals: [0, 1, 3, 5, 7, 8, 10], img: "å®¿å‘½", pref: "flat" },
        { id: "phrygian_dom", name: "ãƒ•ãƒªã‚¸ã‚¢ãƒ³Dom", intervals: [0, 1, 4, 5, 7, 8, 10], img: "å¨åœ§", pref: "flat" },
        { id: "dim_hw", name: "åŠå…¨ãƒ‡ã‚£ãƒŸ", intervals: [0, 1, 3, 4, 6, 7, 9, 10], img: "å®çŸ³", pref: "flat" },
        { id: "dim_wh", name: "å…¨åŠãƒ‡ã‚£ãƒŸ", intervals: [0, 2, 3, 5, 6, 8, 9, 11], img: "ç¡¬è³ª", pref: "sharp" },
        { id: "messiaen7", name: "ãƒ¡ã‚·ã‚¢ãƒ³ç¬¬7", intervals: [0, 1, 2, 3, 5, 6, 7, 8, 9, 11], img: "ã‚«ã‚ªã‚¹", pref: "sharp" },
        { id: "spiral", name: "èºæ—‹éŸ³éš", intervals: [0, 2, 4, 6, 8, 10, 13, 15, 17, 19, 21, 23], img: "ç„¡é™", pref: "sharp" }
    ];

    let currentProjectName = "My Sonata";
    let allProjects = { "My Sonata": [] };

    const inputGrid = document.getElementById('inputGrid');
    for(let i=1; i<=8; i++) {
        inputGrid.innerHTML += `<div class="converter-input"><label>${i}</label><select class="deg-in" onchange="update()"><option value="-1">-</option>${majorScaleNotes.map((name,idx)=>`<option value="${idx}">${name}</option>`).join('')}</select></div>`;
    }

    function calculateTotal() {
        let totalSec = 0;
        document.querySelectorAll('.timeline-item').forEach(item => {
            const bars = parseFloat(item.querySelector('.input-bars').value) || 0;
            const bpm = parseFloat(item.querySelector('.input-bpm').value) || 120;
            const sec = (bars * 4) * (60 / bpm);
            item.querySelector('.duration-cell').innerText = Math.round(sec) + "s";
            totalSec += sec;
        });
        const m = Math.floor(totalSec / 60); const s = Math.round(totalSec % 60);
        document.getElementById('totalDisplay').innerText = `ç·æ¼”å¥æ™‚é–“: ${m}åˆ† ${s}ç§’`;
    }

    function saveToLocal() {
        const data = [];
        document.querySelectorAll('.timeline-item').forEach(item => {
            data.push({ bars: item.querySelector('.input-bars').value, bpm: item.querySelector('.input-bpm').value, secName: item.querySelector('.input-sec').value, scale: item.querySelector('.select-scale').value, memo: item.querySelector('.input-memo').value });
        });
        allProjects[currentProjectName] = data;
        localStorage.setItem('sonataCompleteV3', JSON.stringify(allProjects));
        document.getElementById('saveStatus').innerText = "ä¿å­˜æ¸ˆã¿ " + new Date().toLocaleTimeString();
    }

    function addTimelineRow(bars="32", bpm="120", secName="", scaleName="ç‰çƒéŸ³éš", memo="") {
        const container = document.getElementById('timeline');
        const div = document.createElement('div');
        div.className = 'timeline-item';
        div.innerHTML = `<input type="number" class="input-bars" value="${bars}" oninput="calculateTotal(); saveToLocal();"> <input type="number" class="input-bpm" value="${bpm}" oninput="calculateTotal(); saveToLocal();"> <input type="text" class="input-sec" value="${secName}" oninput="saveToLocal();"> <select class="select-scale" onchange="saveToLocal();">${scales.map(s => `<option ${s.name===scaleName?'selected':''}>${s.name}</option>`).join('')}</select> <input type="text" class="input-memo" value="${memo}" oninput="saveToLocal();"> <div class="duration-cell">0s</div> <button class="del-btn" onclick="this.parentElement.remove(); calculateTotal(); saveToLocal();">Ã—</button>`;
        container.appendChild(div); calculateTotal();
    }

    function switchProject() {
        currentProjectName = document.getElementById('projectList').value;
        document.getElementById('timeline').innerHTML = "";
        const data = allProjects[currentProjectName];
        if (data && data.length > 0) data.forEach(d => addTimelineRow(d.bars, d.bpm, d.secName, d.scale, d.memo));
        else addTimelineRow("64", "120", "æç¤ºéƒ¨", "ç‰çƒéŸ³éš", "");
        calculateTotal();
    }

    const keySelect = document.getElementById('keySelect');
    notesFlat.forEach((n, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = n; keySelect.appendChild(opt); });

    function update() {
        const shift = parseInt(keySelect.value);
        const tbody = document.getElementById('tableBody');
        const degInputs = Array.from(document.querySelectorAll('.deg-in')).map(s => parseInt(s.value));
        const isFlat = [1, 3, 5, 8, 10].includes(shift);
        
        // å…±é€šãƒ¡ãƒ­ãƒ‡ã‚£åˆ†æç”¨
        const resultsMap = {}; // { "C E G": [scaleID, ...] }
        const scaleCalculations = [];

        scales.forEach(s => {
            const noteList = (s.pref === "flat") || (isFlat && s.pref !== "sharp") ? notesFlat : notesSharp;
            
            // å¤‰æ›ãƒ¡ãƒ­ãƒ‡ã‚£è¨ˆç®—
            const convertedRaw = degInputs.filter(v => v !== -1).map(v => {
                const targetInterval = s.intervals[v % s.intervals.length];
                const finalIdx = targetInterval === null ? ([0, 2, 4, 5, 7, 9, 11][v % 7]) : targetInterval;
                return noteList[(finalIdx + shift) % 12];
            });
            const melodyStr = convertedRaw.join(" ");

            // è‰²åˆ†ã‘HTML
            const convertedHTML = degInputs.filter(v => v !== -1).map(v => {
                const targetInterval = s.intervals[v % s.intervals.length];
                const finalIdx = targetInterval === null ? ([0, 2, 4, 5, 7, 9, 11][v % 7]) : targetInterval;
                const noteName = noteList[(finalIdx + shift) % 12];
                return `<span class="${targetInterval === null ? 'out-scale' : 'in-scale'}">${noteName}</span>`;
            }).join(" ");

            // ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ç™»éŒ²
            if (melodyStr) {
                if (!resultsMap[melodyStr]) resultsMap[melodyStr] = [];
                resultsMap[melodyStr].push(s.id);
            }

            const validInts = s.intervals.filter(v => v !== null);
            const scaleNotes = validInts.map(i => noteList[(i + shift) % 12]).join(" ");
            let tertial = []; let temp = [...validInts]; let i = 0;
            while (temp.length > 0) { tertial.push(temp[i]); temp.splice(i, 1); if (temp.length > 0) i = (i + 1) % temp.length; }
            const chordNotes = tertial.map(i => noteList[(i + shift) % 12]).join(" ");

            scaleCalculations.push({ s, convertedHTML, melodyStr, scaleNotes, chordNotes });
        });

        // é‡è¤‡ã‚°ãƒ«ãƒ¼ãƒ—ã«è¨˜å·ã‚’å‰²ã‚Šå½“ã¦
        const groupSymbols = {};
        const symbols = "â’¶â’·â’¸â’¹â’ºâ’»â’¼â’½â’¾â’¿â“€â“â“‚â“ƒâ“„â“…â“†â“‡â“ˆâ“‰â“Šâ“‹â“Œâ“â“â“";
        let symbolIdx = 0;
        Object.keys(resultsMap).forEach(key => {
            if (resultsMap[key].length > 1 && key !== "") {
                groupSymbols[key] = symbols[symbolIdx % symbols.length];
                symbolIdx++;
            }
        });

        // æç”»
        tbody.innerHTML = "";
        scaleCalculations.forEach(item => {
            const symbol = groupSymbols[item.melodyStr] || "";
            const markHTML = symbol ? `<span class="group-mark">${symbol}</span>` : "";
            tbody.innerHTML += `<tr>
                <td style="font-weight:bold;">${item.s.name}</td>
                <td class="notes-text">${markHTML}${item.convertedHTML}</td>
                <td class="notes-text">${item.scaleNotes}</td>
                <td class="notes-text chord-notes">${item.chordNotes}</td>
                <td style="font-size:0.7rem;">${item.s.img}</td>
            </tr>`;
        });
    }

    function createNewProject() {
        const name = prompt("æ›²å:");
        if (name && !allProjects[name]) { allProjects[name] = []; currentProjectName = name; renderProjectList(); switchProject(); saveToLocal(); }
    }

    function renderProjectList() {
        const list = document.getElementById('projectList'); list.innerHTML = "";
        Object.keys(allProjects).forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; if (name === currentProjectName) opt.selected = true; list.appendChild(opt); });
    }

    window.onload = () => {
        const saved = localStorage.getItem('sonataCompleteV3');
        if (saved) allProjects = JSON.parse(saved);
        renderProjectList(); switchProject(); update();
    };
</script>
</body>
</html>
